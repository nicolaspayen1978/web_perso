<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ...head content unchanged... -->
</head>
<body>
  <!-- ...top of body unchanged... -->
  <script type="module">
    import PhotoSwipeLightbox from 'https://unpkg.com/photoswipe@5/dist/photoswipe-lightbox.esm.js';

    async function loadGallery() {
      const response = await fetch('/api/gallery?action=public-load');
      if (!response.ok) {
        console.error("❌ Failed to load gallery:", response.statusText);
        return;
      }
      const photos = await response.json();

      const gallery = document.getElementById('gallery');

      for (const photo of photos) {
        const fullSrc = `photos/${encodeURIComponent(photo.filename)}`;
        const thumbSrc = `photos/${encodeURIComponent(photo.thumbnail)}`;

        const link = document.createElement('a');
        link.href = fullSrc;
        link.setAttribute('data-pswp-width', photo.width);
        link.setAttribute('data-pswp-height', photo.height);
        link.setAttribute('data-pswp-src', fullSrc);
        link.setAttribute('data-title', photo.title);

        link.setAttribute('data-meta', JSON.stringify({
          title: photo.title,
          location: photo.location,
          description: photo.description,
          dimensions: photo.dimensions,
          format_labels: photo.format_labels,
          print_editions: photo.print_editions,
          price_details: photo.price_details,
          print_formats: photo.print_formats
        }));

        const img = document.createElement('img');
        img.src = thumbSrc;
        img.alt = photo.title;
        img.loading = 'lazy';

        link.appendChild(img);
        gallery.appendChild(link);
      }

      $('#gallery').justifiedGallery({
        rowHeight: 250,
        margins: 5,
        lastRow: 'nojustify',
        captions: false
      });

      const lightbox = new PhotoSwipeLightbox({
        gallery: '#gallery',
        children: 'a',
        pswpModule: () => import('https://unpkg.com/photoswipe@5/dist/photoswipe.esm.js')
      });

      let infoPanelEl;

      lightbox.on('uiRegister', function () {
        lightbox.pswp.ui.registerElement({
          name: 'info-button',
          order: 8,
          isButton: true,
          html: '<div class="pswp-info-button">i</div>',
          onClick: () => {
            if (infoPanelEl) {
              const isVisible = infoPanelEl.style.display === 'block';
              infoPanelEl.style.display = isVisible ? 'none' : 'block';
            }
          }
        });

        lightbox.pswp.ui.registerElement({
          name: 'info-panel',
          order: 9,
          isButton: false,
          appendTo: 'root',
          html: '<div class="pswp-info-panel"></div>',
          onInit: (el, pswp) => {
            infoPanelEl = el;
            pswp.on('change', () => {
              const currSlide = pswp.currSlide;
              const elData = currSlide.data.element;
              const metaRaw = elData?.getAttribute('data-meta') || '{}';
              const meta = JSON.parse(metaRaw);
              const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
              const buttonClass = prefersDark ? 'print-request light' : 'print-request dark';
              const title = meta.title || 'Photo Request';

              el.style.display = 'none';
              el.style.backgroundColor = '#fff';
              el.style.color = '#222';
              el.style.padding = '1.4rem 1.6rem';
              el.style.borderRadius = '12px';
              el.style.maxWidth = '440px';
              el.style.lineHeight = '1.7';
              el.style.boxShadow = '0 8px 24px rgba(0, 0, 0, 0.25)';
              el.style.position = 'absolute';
              el.style.bottom = '80px';
              el.style.left = '50%';
              el.style.transform = 'translateX(-50%)';
              el.style.zIndex = '100';

              el.innerHTML = `<strong style="font-size:1.1rem;">${meta.title}</strong>...`; // trimmed
            });
          }
        });
      });

      // ✅ Corrected filtering logic
      document.getElementById("format-filter").addEventListener("change", function () {
        const selected = this.value;
        const links = document.querySelectorAll("#gallery a");

        links.forEach(link => {
          const meta = JSON.parse(link.getAttribute("data-meta") || "{}");
          const formats = (meta.print_formats || []).map(f => f.toUpperCase());

          if (
            selected === "all" ||
            (selected === "L" && formats.includes("L")) ||
            (selected === "XL" && formats.includes("XL"))
          ) {
            link.style.display = "";
          } else {
            link.style.display = "none";
          }
        });
      });

      lightbox.init();
    }

    loadGallery();
  </script>
</body>
</html>
